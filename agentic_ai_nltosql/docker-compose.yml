version: "3.8"

networks:
  proxy:
  internal:

volumes:
  mysql_data:
  nginx_certs:
  nginx_vhost:
  nginx_html:
  nginx_acme:
  nginx_dhparam:

services:

  # -------------------------------------------------------------
  # NGINX Reverse Proxy (jwilder)
  # -------------------------------------------------------------
  nginx-proxy:
    image: jwilder/nginx-proxy:latest
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    labels:
      com.github.nginx-proxy.nginx: "true"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro,z
      - nginx_certs:/etc/nginx/certs
      - nginx_vhost:/etc/nginx/vhost.d
      - nginx_html:/usr/share/nginx/html
      - nginx_dhparam:/etc/nginx/dhparam
      
    networks:
      - proxy

  # -------------------------------------------------------------
  # Let's Encrypt Companion
  # -------------------------------------------------------------
  letsencrypt:
    image: jrcs/letsencrypt-nginx-proxy-companion:latest
    container_name: nginx-proxy-le
    restart: unless-stopped
    environment:
      - DEFAULT_EMAIL=shandba92@gmail.com
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - nginx_certs:/etc/nginx/certs
      - nginx_vhost:/etc/nginx/vhost.d
      - nginx_html:/usr/share/nginx/html
      - nginx_acme:/etc/acme.sh
    networks:
      - proxy
    depends_on:
      - nginx-proxy

  # -------------------------------------------------------------
  # MySQL Database
  # -------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: agentic_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-ai_agent_db}"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - internal

  # -------------------------------------------------------------
  # Agentic AI Application (Gradio + MCP)
  # -------------------------------------------------------------
  agentic-app:
    build:
      context: .
      dockerfile: Dockerfile
      ##target: final      # ✅ FORCE USE THE FINAL STAGE
    container_name: agentic_app
    restart: unless-stopped
    depends_on:
      - mysql
      - nginx-proxy
      - letsencrypt

    environment:
      VIRTUAL_HOST: "YOUR_DOMAIN.com"
      LETSENCRYPT_HOST: "YOUR_DOMAIN.com"
      LETSENCRYPT_EMAIL: "your-email@example.com"
      VIRTUAL_PORT: "7860"

      MYSQL_HOST: "mysql"
      MYSQL_USER: "root"
      MYSQL_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-ai_agent_db}"
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      LLM_MODEL: "${LLM_MODEL:-gemini-2.5-pro}"

      LANGCHAIN_TRACING_V2: "true"
      LANGCHAIN_API_KEY: "${LANGCHAIN_API_KEY}"
      LANGCHAIN_PROJECT: "agentic-production"

    expose:
      - "7860"   # ✅ Only the Gradio UI port (required)
                 # ❌ REMOVE 8080 — it confused nginx-proxy

    networks:
      - proxy
      - internal
