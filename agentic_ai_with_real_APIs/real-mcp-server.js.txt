#!/usr/bin/env node

/**
 * Real-Time Agentic AI MCP Server with FREE Real APIs
 * No mock data - actual working integrations!
 */

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from '@modelcontextprotocol/sdk/types.js';
import axios from 'axios';
import nodemailer from 'nodemailer';

// ============================================================================
// REAL API CONFIGURATIONS (All FREE!)
// ============================================================================

const CONFIG = {
  // OpenWeather API (Free tier: 60 calls/min, 1M calls/month)
  // Sign up: https://openweathermap.org/api
  OPENWEATHER_API_KEY: process.env.OPENWEATHER_API_KEY || '',
  
  // NewsAPI (Free tier: 100 requests/day)
  // Sign up: https://newsapi.org/register
  NEWS_API_KEY: process.env.NEWS_API_KEY || '',
  
  // ExchangeRate API (Free tier: 1500 requests/month)
  // Sign up: https://www.exchangerate-api.com/
  EXCHANGERATE_API_KEY: process.env.EXCHANGERATE_API_KEY || '',
  
  // GitHub API (5000 requests/hour authenticated, 60 unauthenticated)
  // Generate token: https://github.com/settings/tokens
  GITHUB_TOKEN: process.env.GITHUB_TOKEN || '',
  
  // REST Countries API (No key needed, free)
  // Docs: https://restcountries.com/
  
  // Email via Gmail (Free)
  // Setup: https://support.google.com/accounts/answer/185833
  EMAIL_USER: process.env.EMAIL_USER || '',
  EMAIL_PASS: process.env.EMAIL_PASS || '', // App password
  
  // JSONPlaceholder (Free fake API for testing)
  // No signup needed: https://jsonplaceholder.typicode.com/
  
  // CoinGecko API (Free tier: 10-50 calls/min)
  // No key needed: https://www.coingecko.com/en/api
};

// ============================================================================
// API CLIENT SETUP
// ============================================================================

const weatherAPI = axios.create({
  baseURL: 'https://api.openweathermap.org/data/2.5',
  timeout: 10000,
});

const newsAPI = axios.create({
  baseURL: 'https://newsapi.org/v2',
  timeout: 10000,
});

const exchangeRateAPI = axios.create({
  baseURL: 'https://v6.exchangerate-api.com/v6',
  timeout: 10000,
});

const githubAPI = axios.create({
  baseURL: 'https://api.github.com',
  headers: CONFIG.GITHUB_TOKEN ? {
    'Authorization': `Bearer ${CONFIG.GITHUB_TOKEN}`,
    'Accept': 'application/vnd.github.v3+json'
  } : {},
  timeout: 10000,
});

const countriesAPI = axios.create({
  baseURL: 'https://restcountries.com/v3.1',
  timeout: 10000,
});

const cryptoAPI = axios.create({
  baseURL: 'https://api.coingecko.com/api/v3',
  timeout: 10000,
});

const placeholderAPI = axios.create({
  baseURL: 'https://jsonplaceholder.typicode.com',
  timeout: 10000,
});

// Email transporter
let emailTransporter = null;
if (CONFIG.EMAIL_USER && CONFIG.EMAIL_PASS) {
  emailTransporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: CONFIG.EMAIL_USER,
      pass: CONFIG.EMAIL_PASS,
    },
  });
}

// ============================================================================
// TOOL IMPLEMENTATIONS
// ============================================================================

const tools = {
  // ==========================================================================
  // WEATHER TOOLS (OpenWeather API)
  // ==========================================================================
  
  async get_weather({ city, units = 'metric' }) {
    try {
      if (!CONFIG.OPENWEATHER_API_KEY) {
        return {
          success: false,
          error: 'OpenWeather API key not configured. Get free key at: https://openweathermap.org/api'
        };
      }

      const response = await weatherAPI.get('/weather', {
        params: {
          q: city,
          appid: CONFIG.OPENWEATHER_API_KEY,
          units: units // metric, imperial, kelvin
        }
      });

      const data = response.data;
      return {
        success: true,
        data: {
          city: data.name,
          country: data.sys.country,
          temperature: data.main.temp,
          feels_like: data.main.feels_like,
          humidity: data.main.humidity,
          pressure: data.main.pressure,
          description: data.weather[0].description,
          wind_speed: data.wind.speed,
          clouds: data.clouds.all,
          units: units === 'metric' ? '°C' : units === 'imperial' ? '°F' : 'K'
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  async get_forecast({ city, days = 5 }) {
    try {
      if (!CONFIG.OPENWEATHER_API_KEY) {
        return {
          success: false,
          error: 'OpenWeather API key not configured'
        };
      }

      const response = await weatherAPI.get('/forecast', {
        params: {
          q: city,
          appid: CONFIG.OPENWEATHER_API_KEY,
          units: 'metric',
          cnt: days * 8 // 8 forecasts per day (3-hour intervals)
        }
      });

      const forecasts = response.data.list.map(item => ({
        date: item.dt_txt,
        temp: item.main.temp,
        description: item.weather[0].description,
        humidity: item.main.humidity,
        wind_speed: item.wind.speed
      }));

      return {
        success: true,
        data: {
          city: response.data.city.name,
          country: response.data.city.country,
          forecasts: forecasts.slice(0, days * 8)
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  // ==========================================================================
  // NEWS TOOLS (NewsAPI)
  // ==========================================================================

  async get_top_news({ country = 'us', category = 'general', limit = 10 }) {
    try {
      if (!CONFIG.NEWS_API_KEY) {
        return {
          success: false,
          error: 'NewsAPI key not configured. Get free key at: https://newsapi.org/register'
        };
      }

      const response = await newsAPI.get('/top-headlines', {
        params: {
          country: country,
          category: category, // business, entertainment, health, science, sports, technology
          pageSize: limit,
          apiKey: CONFIG.NEWS_API_KEY
        }
      });

      const articles = response.data.articles.map(article => ({
        title: article.title,
        description: article.description,
        source: article.source.name,
        author: article.author,
        url: article.url,
        published_at: article.publishedAt
      }));

      return {
        success: true,
        data: {
          total_results: response.data.totalResults,
          articles: articles
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  async search_news({ query, from_date, sort_by = 'publishedAt', limit = 10 }) {
    try {
      if (!CONFIG.NEWS_API_KEY) {
        return {
          success: false,
          error: 'NewsAPI key not configured'
        };
      }

      const response = await newsAPI.get('/everything', {
        params: {
          q: query,
          from: from_date,
          sortBy: sort_by, // relevancy, popularity, publishedAt
          pageSize: limit,
          apiKey: CONFIG.NEWS_API_KEY
        }
      });

      const articles = response.data.articles.map(article => ({
        title: article.title,
        description: article.description,
        source: article.source.name,
        url: article.url,
        published_at: article.publishedAt
      }));

      return {
        success: true,
        data: {
          total_results: response.data.totalResults,
          articles: articles
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  // ==========================================================================
  // CURRENCY & EXCHANGE TOOLS
  // ==========================================================================

  async convert_currency({ amount, from_currency, to_currency }) {
    try {
      if (!CONFIG.EXCHANGERATE_API_KEY) {
        return {
          success: false,
          error: 'ExchangeRate API key not configured. Get free key at: https://www.exchangerate-api.com/'
        };
      }

      const response = await exchangeRateAPI.get(
        `/${CONFIG.EXCHANGERATE_API_KEY}/pair/${from_currency}/${to_currency}/${amount}`
      );

      return {
        success: true,
        data: {
          from: from_currency,
          to: to_currency,
          amount: amount,
          converted_amount: response.data.conversion_result,
          exchange_rate: response.data.conversion_rate,
          last_update: response.data.time_last_update_utc
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  async get_exchange_rates({ base_currency = 'USD' }) {
    try {
      if (!CONFIG.EXCHANGERATE_API_KEY) {
        return {
          success: false,
          error: 'ExchangeRate API key not configured'
        };
      }

      const response = await exchangeRateAPI.get(
        `/${CONFIG.EXCHANGERATE_API_KEY}/latest/${base_currency}`
      );

      return {
        success: true,
        data: {
          base: base_currency,
          rates: response.data.conversion_rates,
          last_update: response.data.time_last_update_utc
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  // ==========================================================================
  // GITHUB TOOLS
  // ==========================================================================

  async search_github_repos({ query, sort = 'stars', limit = 10 }) {
    try {
      const response = await githubAPI.get('/search/repositories', {
        params: {
          q: query,
          sort: sort, // stars, forks, updated
          per_page: limit
        }
      });

      const repos = response.data.items.map(repo => ({
        name: repo.name,
        full_name: repo.full_name,
        description: repo.description,
        stars: repo.stargazers_count,
        forks: repo.forks_count,
        language: repo.language,
        url: repo.html_url,
        created_at: repo.created_at,
        updated_at: repo.updated_at
      }));

      return {
        success: true,
        data: {
          total_count: response.data.total_count,
          repositories: repos
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  async get_github_user({ username }) {
    try {
      const response = await githubAPI.get(`/users/${username}`);
      
      return {
        success: true,
        data: {
          username: response.data.login,
          name: response.data.name,
          bio: response.data.bio,
          public_repos: response.data.public_repos,
          followers: response.data.followers,
          following: response.data.following,
          avatar_url: response.data.avatar_url,
          profile_url: response.data.html_url,
          created_at: response.data.created_at
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  // ==========================================================================
  // COUNTRY INFORMATION TOOLS (No API key needed)
  // ==========================================================================

  async get_country_info({ country_name }) {
    try {
      const response = await countriesAPI.get(`/name/${country_name}`);
      const country = response.data[0];

      return {
        success: true,
        data: {
          name: country.name.common,
          official_name: country.name.official,
          capital: country.capital?.[0],
          region: country.region,
          subregion: country.subregion,
          population: country.population,
          area: country.area,
          languages: country.languages,
          currencies: country.currencies,
          timezone: country.timezones[0],
          flag: country.flag,
          maps: country.maps.googleMaps
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  // ==========================================================================
  // CRYPTOCURRENCY TOOLS (CoinGecko - No API key needed)
  // ==========================================================================

  async get_crypto_price({ coin_id = 'bitcoin', currency = 'usd' }) {
    try {
      const response = await cryptoAPI.get('/simple/price', {
        params: {
          ids: coin_id,
          vs_currencies: currency,
          include_24hr_change: true,
          include_market_cap: true
        }
      });

      const data = response.data[coin_id];
      return {
        success: true,
        data: {
          coin: coin_id,
          price: data[currency],
          currency: currency.toUpperCase(),
          market_cap: data[`${currency}_market_cap`],
          change_24h: data[`${currency}_24h_change`]
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  async get_trending_crypto() {
    try {
      const response = await cryptoAPI.get('/search/trending');

      const trending = response.data.coins.map(item => ({
        name: item.item.name,
        symbol: item.item.symbol,
        market_cap_rank: item.item.market_cap_rank,
        price_btc: item.item.price_btc
      }));

      return {
        success: true,
        data: {
          trending_coins: trending
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.response?.data?.message || error.message
      };
    }
  },

  // ==========================================================================
  // EMAIL TOOLS (Gmail)
  // ==========================================================================

  async send_email({ to, subject, text, html }) {
    try {
      if (!emailTransporter) {
        return {
          success: false,
          error: 'Email not configured. Set EMAIL_USER and EMAIL_PASS environment variables'
        };
      }

      const info = await emailTransporter.sendMail({
        from: CONFIG.EMAIL_USER,
        to: to,
        subject: subject,
        text: text,
        html: html || text
      });

      return {
        success: true,
        message: `Email sent successfully to ${to}`,
        messageId: info.messageId
      };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  },

  // ==========================================================================
  // PLACEHOLDER API TOOLS (For testing - No key needed)
  // ==========================================================================

  async get_todos({ user_id, limit = 10 }) {
    try {
      const response = await placeholderAPI.get('/todos', {
        params: {
          userId: user_id,
          _limit: limit
        }
      });

      return {
        success: true,
        data: response.data
      };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  },

  async create_post({ title, body, user_id = 1 }) {
    try {
      const response = await placeholderAPI.post('/posts', {
        title: title,
        body: body,
        userId: user_id
      });

      return {
        success: true,
        data: response.data,
        message: 'Post created successfully (demo)'
      };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }
};

// ============================================================================
// TOOL DEFINITIONS FOR MCP
// ============================================================================

const toolDefinitions = [
  {
    name: 'get_weather',
    description: 'Get current weather for a city using OpenWeather API',
    inputSchema: {
      type: 'object',
      properties: {
        city: {
          type: 'string',
          description: 'City name (e.g., "London", "New York")'
        },
        units: {
          type: 'string',
          enum: ['metric', 'imperial', 'kelvin'],
          description: 'Temperature units (default: metric)',
          default: 'metric'
        }
      },
      required: ['city']
    }
  },
  {
    name: 'get_forecast',
    description: 'Get weather forecast for upcoming days',
    inputSchema: {
      type: 'object',
      properties: {
        city: {
          type: 'string',
          description: 'City name'
        },
        days: {
          type: 'number',
          description: 'Number of days (1-5)',
          default: 5
        }
      },
      required: ['city']
    }
  },
  {
    name: 'get_top_news',
    description: 'Get top news headlines by country and category using NewsAPI',
    inputSchema: {
      type: 'object',
      properties: {
        country: {
          type: 'string',
          description: 'Country code (us, gb, ca, au, etc.)',
          default: 'us'
        },
        category: {
          type: 'string',
          enum: ['business', 'entertainment', 'health', 'science', 'sports', 'technology', 'general'],
          description: 'News category',
          default: 'general'
        },
        limit: {
          type: 'number',
          description: 'Number of articles (max 100)',
          default: 10
        }
      }
    }
  },
  {
    name: 'search_news',
    description: 'Search news articles by keyword',
    inputSchema: {
      type: 'object',
      properties: {
        query: {
          type: 'string',
          description: 'Search query'
        },
        from_date: {
          type: 'string',
          description: 'Start date (YYYY-MM-DD format)'
        },
        sort_by: {
          type: 'string',
          enum: ['relevancy', 'popularity', 'publishedAt'],
          default: 'publishedAt'
        },
        limit: {
          type: 'number',
          default: 10
        }
      },
      required: ['query']
    }
  },
  {
    name: 'convert_currency',
    description: 'Convert amount between currencies using live exchange rates',
    inputSchema: {
      type: 'object',
      properties: {
        amount: {
          type: 'number',
          description: 'Amount to convert'
        },
        from_currency: {
          type: 'string',
          description: 'Source currency code (e.g., USD, EUR, GBP)'
        },
        to_currency: {
          type: 'string',
          description: 'Target currency code'
        }
      },
      required: ['amount', 'from_currency', 'to_currency']
    }
  },
  {
    name: 'get_exchange_rates',
    description: 'Get all exchange rates for a base currency',
    inputSchema: {
      type: 'object',
      properties: {
        base_currency: {
          type: 'string',
          description: 'Base currency code',
          default: 'USD'
        }
      }
    }
  },
  {
    name: 'search_github_repos',
    description: 'Search GitHub repositories',
    inputSchema: {
      type: 'object',
      properties: {
        query: {
          type: 'string',
          description: 'Search query (e.g., "machine learning python")'
        },
        sort: {
          type: 'string',
          enum: ['stars', 'forks', 'updated'],
          default: 'stars'
        },
        limit: {
          type: 'number',
          default: 10
        }
      },
      required: ['query']
    }
  },
  {
    name: 'get_github_user',
    description: 'Get GitHub user profile information',
    inputSchema: {
      type: 'object',
      properties: {
        username: {
          type: 'string',
          description: 'GitHub username'
        }
      },
      required: ['username']
    }
  },
  {
    name: 'get_country_info',
    description: 'Get detailed information about a country',
    inputSchema: {
      type: 'object',
      properties: {
        country_name: {
          type: 'string',
          description: 'Country name (e.g., "India", "Japan")'
        }
      },
      required: ['country_name']
    }
  },
  {
    name: 'get_crypto_price',
    description: 'Get current cryptocurrency price',
    inputSchema: {
      type: 'object',
      properties: {
        coin_id: {
          type: 'string',
          description: 'Coin ID (bitcoin, ethereum, cardano, etc.)',
          default: 'bitcoin'
        },
        currency: {
          type: 'string',
          description: 'Currency (usd, eur, gbp, etc.)',
          default: 'usd'
        }
      }
    }
  },
  {
    name: 'get_trending_crypto',
    description: 'Get trending cryptocurrencies',
    inputSchema: {
      type: 'object',
      properties: {}
    }
  },
  {
    name: 'send_email',
    description: 'Send an email via Gmail',
    inputSchema: {
      type: 'object',
      properties: {
        to: {
          type: 'string',
          description: 'Recipient email address'
        },
        subject: {
          type: 'string',
          description: 'Email subject'
        },
        text: {
          type: 'string',
          description: 'Email body (plain text)'
        },
        html: {
          type: 'string',
          description: 'Email body (HTML, optional)'
        }
      },
      required: ['to', 'subject', 'text']
    }
  },
  {
    name: 'get_todos',
    description: 'Get todo list (demo API for testing)',
    inputSchema: {
      type: 'object',
      properties: {
        user_id: {
          type: 'number',
          description: 'User ID (1-10)',
          default: 1
        },
        limit: {
          type: 'number',
          default: 10
        }
      }
    }
  },
  {
    name: 'create_post',
    description: 'Create a post (demo API for testing)',
    inputSchema: {
      type: 'object',
      properties: {
        title: {
          type: 'string',
          description: 'Post title'
        },
        body: {
          type: 'string',
          description: 'Post content'
        },
        user_id: {
          type: 'number',
          default: 1
        }
      },
      required: ['title', 'body']
    }
  }
];

// ============================================================================
// MCP SERVER SETUP
// ============================================================================

const server = new Server(
  {
    name: 'real-api-mcp-server',
    version: '1.0.0',
  },
  {
    capabilities: {
      tools: {},
    },
  }
);

server.setRequestHandler(ListToolsRequestSchema, async () => ({
  tools: toolDefinitions,
}));

server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name, arguments: args } = request.params;

  try {
    if (!tools[name]) {
      throw new Error(`Unknown tool: ${name}`);
    }

    console.error(`[MCP] Executing: ${name}`);
    const result = await tools[name](args || {});
    console.error(`[MCP] Result: ${result.success ? 'Success' : 'Failed'}`);

    return {
      content: [
        {
          type: 'text',
          text: JSON.stringify(result, null, 2),
        },
      ],
    };
  } catch (error) {
    console.error(`[MCP] Error:`, error);
    return {
      content: [
        {
          type: 'text',
          text: JSON.stringify({
            success: false,
            error: error.message,
          }),
        },
      ],
      isError: true,
    };
  }
});

async function main() {
  const transport = new StdioServerTransport();
  await server.connect(transport);
  console.error('[MCP] Real API MCP Server running with FREE APIs!');
  console.error('[MCP] Available: Weather, News, Currency, GitHub, Country Info, Crypto, Email');
}

main().catch((error) => {
  console.error('[MCP] Fatal error:', error);
  process.exit(1);
});